//Lava OS
//PageFault
//20-04-10-00-16

#include <stddef.h>
#include <asm.h>
#include <string.h>
#include <vbe.h>
#include <lava.h>
#include <vm.h>
#include <mm.h>
#include <int.h>
#include <kernel.h>

const u8 tofu[] = {
	0xff,0xff,0xc3,0xc3,0xa5,0xa5,0x99,0x99,0x99,0x99,0xa5,0xa5,0xc3,0xc3,0xff,0xff
};
const u8 _bmp[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//20
	0x00,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x00,0x00,0x08,0x08,0x00,0x00,//21
	0x14,0x14,0x14,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//22
	0x00,0x22,0x22,0x22,0x7F,0x22,0x22,0x22,0x22,0x22,0x7F,0x22,0x22,0x22,0x00,0x00,//23
	0x08,0x5C,0x6A,0x49,0x49,0x09,0x0A,0x1C,0x28,0x48,0x49,0x49,0x2B,0x1D,0x08,0x08,//24
	0x46,0x49,0x29,0x29,0x16,0x10,0x08,0x08,0x04,0x34,0x4A,0x4A,0x49,0x31,0x00,0x00,//25
	0x00,0x0E,0x11,0x11,0x11,0x09,0x06,0xE2,0x45,0x49,0x51,0x21,0x62,0x9C,0x00,0x00,//26
	0x20,0x10,0x08,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//27
	0x40,0x20,0x10,0x10,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x10,0x10,0x20,0x40,0x00,//28
	0x01,0x02,0x04,0x04,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x04,0x04,0x02,0x01,0x00,//29
	0x00,0x00,0x00,0x00,0x00,0x08,0x49,0x2A,0x1C,0x2A,0x49,0x08,0x00,0x00,0x00,0x00,//2a
	0x00,0x00,0x00,0x00,0x00,0x08,0x08,0x08,0x7F,0x08,0x08,0x08,0x00,0x00,0x00,0x00,//2b
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x10,0x10,0x08,//2c
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//2d
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,//2e
	0x40,0x40,0x20,0x20,0x10,0x10,0x10,0x08,0x08,0x04,0x04,0x02,0x02,0x02,0x01,0x01,//2f
	0x00,0x18,0x24,0x24,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x24,0x18,0x00,0x00,//30
	0x00,0x10,0x18,0x14,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x10,0x7C,0x00,0x00,//31
	0x00,0x18,0x24,0x42,0x42,0x40,0x20,0x10,0x08,0x04,0x04,0x02,0x02,0x7E,0x00,0x00,//32
	0x00,0x18,0x24,0x42,0x40,0x40,0x20,0x18,0x20,0x40,0x40,0x42,0x24,0x18,0x00,0x00,//33
	0x00,0x30,0x30,0x30,0x28,0x28,0x28,0x24,0x24,0x22,0x7E,0x20,0x20,0x78,0x00,0x00,//34
	0x00,0x3E,0x02,0x02,0x02,0x1A,0x26,0x40,0x40,0x40,0x40,0x42,0x24,0x18,0x00,0x00,//35
	0x00,0x18,0x24,0x42,0x02,0x1A,0x26,0x42,0x42,0x42,0x42,0x42,0x24,0x18,0x00,0x00,//36
	0x00,0x7E,0x42,0x42,0x20,0x20,0x10,0x10,0x10,0x08,0x08,0x08,0x08,0x1C,0x00,0x00,//37
	0x00,0x18,0x24,0x42,0x42,0x42,0x24,0x18,0x24,0x42,0x42,0x42,0x24,0x18,0x00,0x00,//38
	0x00,0x18,0x24,0x42,0x42,0x42,0x42,0x42,0x64,0x58,0x40,0x42,0x24,0x18,0x00,0x00,//39
	0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,//3a
	0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x18,0x18,0x10,0x10,0x08,//3b
	0x00,0x40,0x20,0x10,0x08,0x04,0x02,0x01,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x00,//3c
	0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,0x00,0x7F,0x00,0x00,0x00,0x00,0x00,0x00,//3d
	0x00,0x01,0x02,0x04,0x08,0x10,0x20,0x40,0x40,0x20,0x10,0x08,0x04,0x02,0x01,0x00,//3e
	0x00,0x1C,0x22,0x41,0x41,0x41,0x20,0x10,0x08,0x08,0x00,0x00,0x18,0x18,0x00,0x00,//3f
	0x00,0x1C,0x22,0x41,0x59,0x55,0x55,0x55,0x55,0x55,0x39,0x01,0x62,0x1C,0x00,0x00,//40
	0x00,0x18,0x18,0x18,0x18,0x24,0x24,0x24,0x24,0x7E,0x42,0x42,0x42,0xE7,0x00,0x00,//41
	0x00,0x0F,0x12,0x22,0x22,0x22,0x12,0x1E,0x22,0x42,0x42,0x42,0x22,0x1F,0x00,0x00,//42
	0x00,0x5C,0x62,0x42,0x41,0x01,0x01,0x01,0x01,0x01,0x41,0x42,0x22,0x1C,0x00,0x00,//43
	0x00,0x1F,0x22,0x22,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x22,0x22,0x1F,0x00,0x00,//44
	0x00,0x7F,0x42,0x42,0x02,0x02,0x22,0x3E,0x22,0x02,0x02,0x42,0x42,0x7F,0x00,0x00,//45
	0x00,0x7F,0x42,0x42,0x02,0x02,0x22,0x3E,0x22,0x22,0x02,0x02,0x02,0x0F,0x00,0x00,//46
	0x00,0x5C,0x62,0x42,0x41,0x01,0x01,0x79,0x41,0x41,0x41,0x42,0x62,0x1C,0x00,0x00,//47
	0x00,0xE7,0x42,0x42,0x42,0x42,0x42,0x7E,0x42,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,//48
	0x00,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,//49
	0x00,0xF8,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x21,0x12,0x0C,0x00,//4a
	0x00,0xE7,0x42,0x22,0x12,0x0A,0x0A,0x06,0x0A,0x0A,0x12,0x22,0x42,0xE7,0x00,0x00,//4b
	0x00,0x0F,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x42,0x42,0x7F,0x00,0x00,//4c
	0x00,0xC3,0x42,0x66,0x66,0x66,0x5A,0x5A,0x5A,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,//4d
	0x00,0xE3,0x42,0x46,0x46,0x4A,0x4A,0x4A,0x52,0x52,0x52,0x62,0x62,0x47,0x00,0x00,//4e
	0x00,0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x22,0x1C,0x00,0x00,//4f
	0x00,0x1F,0x22,0x42,0x42,0x42,0x22,0x1E,0x02,0x02,0x02,0x02,0x02,0x0F,0x00,0x00,//50
	0x00,0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x41,0x41,0x49,0x51,0x22,0x5C,0x00,0x00,//51
	0x00,0x3F,0x42,0x42,0x42,0x42,0x3E,0x22,0x42,0x42,0x42,0x42,0x42,0xE7,0x00,0x00,//52
	0x00,0x5C,0x62,0x41,0x41,0x01,0x02,0x1C,0x20,0x40,0x41,0x41,0x23,0x1D,0x00,0x00,//53
	0x00,0x7F,0x49,0x49,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,//54
	0x00,0xE7,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x42,0x24,0x3C,0x00,0x00,//55
	0x00,0xE7,0x42,0x42,0x42,0x42,0x24,0x24,0x24,0x24,0x18,0x18,0x18,0x18,0x00,0x00,//56
	0x00,0xE7,0x42,0x42,0x42,0x5A,0x5A,0x5A,0x5A,0x24,0x24,0x24,0x24,0x24,0x00,0x00,//57
	0x00,0xE7,0x42,0x42,0x24,0x24,0x24,0x18,0x24,0x24,0x24,0x42,0x42,0xE7,0x00,0x00,//58
	0x00,0x77,0x22,0x22,0x22,0x14,0x14,0x14,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,//59
	0x00,0x7F,0x21,0x21,0x10,0x10,0x08,0x08,0x04,0x04,0x02,0x42,0x41,0x7F,0x00,0x00,//5a
	0x00,0x7C,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x04,0x7C,0x00,//5b
	0x01,0x01,0x02,0x02,0x04,0x04,0x04,0x08,0x08,0x10,0x10,0x20,0x20,0x20,0x40,0x40,//5c
	0x00,0x3E,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x3E,0x00,//5d
	0x00,0x08,0x14,0x22,0x41,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//5e
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x7F,0x00,//5f
	0x08,0x10,0x20,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//60
	0x00,0x00,0x00,0x00,0x00,0x0E,0x10,0x20,0x3C,0x22,0x21,0x21,0x31,0x6E,0x00,0x00,//61
	0x03,0x02,0x02,0x02,0x02,0x1A,0x26,0x42,0x42,0x42,0x42,0x42,0x26,0x1A,0x00,0x00,//62
	0x00,0x00,0x00,0x00,0x00,0x0C,0x32,0x21,0x21,0x01,0x01,0x41,0x22,0x1C,0x00,0x00,//63
	0x30,0x20,0x20,0x20,0x20,0x2C,0x32,0x21,0x21,0x21,0x21,0x21,0x32,0x6C,0x00,0x00,//64
	0x00,0x00,0x00,0x00,0x00,0x1C,0x22,0x41,0x41,0x3F,0x01,0x41,0x42,0x3C,0x00,0x00,//65
	0x70,0x08,0x08,0x08,0x08,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x3E,0x00,0x00,//66
	0x00,0x00,0x00,0x00,0x00,0x6C,0x32,0x21,0x21,0x21,0x21,0x32,0x2C,0x20,0x20,0x1E,//67
	0x03,0x02,0x02,0x02,0x02,0x1A,0x26,0x42,0x42,0x42,0x42,0x42,0x42,0xC7,0x00,0x00,//68
	0x00,0x08,0x08,0x00,0x00,0x0C,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x1C,0x00,0x00,//69
	0x00,0x20,0x20,0x00,0x00,0x30,0x20,0x20,0x20,0x20,0x20,0x20,0x20,0x10,0x10,0x0C,//6a
	0x03,0x02,0x02,0x02,0x02,0x72,0x22,0x12,0x0A,0x06,0x0A,0x12,0x22,0x67,0x00,0x00,//6b
	0x0C,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x1C,0x00,0x00,//6c
	0x00,0x00,0x00,0x00,0x00,0x6F,0x92,0x92,0x92,0x92,0x92,0x92,0x92,0xDB,0x00,0x00,//6d
	0x00,0x00,0x00,0x00,0x00,0x1B,0x26,0x42,0x42,0x42,0x42,0x42,0x42,0xC7,0x00,0x00,//6e
	0x00,0x00,0x00,0x00,0x00,0x1C,0x22,0x41,0x41,0x41,0x41,0x41,0x22,0x1C,0x00,0x00,//6f
	0x00,0x00,0x00,0x00,0x00,0x1B,0x26,0x42,0x42,0x42,0x42,0x42,0x26,0x1A,0x02,0x07,//70
	0x00,0x00,0x00,0x00,0x00,0x2C,0x32,0x21,0x21,0x21,0x21,0x21,0x32,0x2C,0x20,0x70,//71
	0x00,0x00,0x00,0x00,0x00,0x3B,0x46,0x42,0x02,0x02,0x02,0x02,0x02,0x07,0x00,0x00,//72
	0x00,0x00,0x00,0x00,0x00,0x5E,0x61,0x41,0x03,0x1C,0x60,0x41,0x43,0x3D,0x00,0x00,//73
	0x00,0x00,0x08,0x08,0x08,0x3E,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x70,0x00,0x00,//74
	0x00,0x00,0x00,0x00,0x00,0x63,0x42,0x42,0x42,0x42,0x42,0x42,0x62,0xDC,0x00,0x00,//75
	0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x42,0x42,0x24,0x24,0x24,0x18,0x18,0x00,0x00,//76
	0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x42,0x5A,0x5A,0x5A,0x24,0x24,0x24,0x00,0x00,//77
	0x00,0x00,0x00,0x00,0x00,0x63,0x22,0x14,0x14,0x08,0x14,0x14,0x22,0x63,0x00,0x00,//78
	0x00,0x00,0x00,0x00,0x00,0xE7,0x42,0x42,0x24,0x24,0x24,0x18,0x18,0x08,0x08,0x06,//79
	0x00,0x00,0x00,0x00,0x00,0x7F,0x41,0x21,0x10,0x08,0x04,0x42,0x41,0x7F,0x00,0x00,//7a
	0x00,0x60,0x10,0x08,0x08,0x08,0x08,0x06,0x08,0x08,0x08,0x08,0x10,0x60,0x00,0x00,//7b
	0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,//7c
	0x00,0x06,0x08,0x10,0x10,0x10,0x10,0x60,0x10,0x10,0x10,0x10,0x08,0x06,0x00,0x00,//7d
	0x00,0x4E,0x31,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,//7e
};

struct _MODEL_STATUS_ {
	int posx;
	int posy;
	int x;
	int y;
};


static int high;
static int width;
static int byte_per_scan_line;
static u8 * lfb;
static int text_color = 0x00000000;
static int back_color = 0xffffffff;
static int byte_per_pixel;

static int model_width;
static int model_high;
static int border_width = 1;
static int model_per_line;
static struct _MODEL_STATUS_ * status;
static int max_cpuid;
static int init = 0;

void draw_char(int ch){
	int cpuid;
	const u8 * map;
	int dx,dy;
	int color;
	int pos;
	int i;
	
	if(!init) return;
	SD();
	cpuid = GetCPUId();
	if(cpuid > max_cpuid) {
		asm("cli\n\thlt"::"a"(cpuid));
		
		
	}
	
	if(ch == '\n'){
		status[cpuid].x = 0;
		status[cpuid].y += 16;
	}
	else if(ch == '\t'){
		status[cpuid].x += 0x3f;
		status[cpuid].x &= 0xffffc0;
	}
	else if(ch == '\r'){
		status[cpuid].x = 0;
		SE();
		return;
	}
	if(status[cpuid].x + 8 > model_width) {
		status[cpuid].x = 0;
		status[cpuid].y += 16;
	}
	if(status[cpuid].y >= model_high){
		for(i = 0;i < status[cpuid].y - 16;i++){
			memcpy(lfb + status[cpuid].posx * byte_per_pixel + (status[cpuid].posy + i) * byte_per_scan_line,
				lfb + status[cpuid].posx * byte_per_pixel + (status[cpuid].posy + i + 16) * byte_per_scan_line,
				model_width * byte_per_pixel);
		}
		for(i = 1;i <= 16;i++){
			memset(lfb + status[cpuid].posx * byte_per_pixel + (status[cpuid].posy + model_high - i) * byte_per_scan_line,
				0xff,model_width * byte_per_pixel);
		}
		status[cpuid].y -= 16;
		///for(i = 0;i < model_high;i++){
		///	memset(lfb + status[cpuid].posx * byte_per_pixel + (status[cpuid].posy + i) * byte_per_scan_line,
		///		0xff,model_width * byte_per_pixel);
		///	
		///}
		///status[cpuid].y = 0;
	}
	if(ch == '\n' || ch == '\t') {
		SE();
		return;
	}
	if(ch <= 0x1f || ch >= 0x7f) map = tofu;
	else map = _bmp + 16 * (ch - 0x20);
	for(dy = 0;dy < 16;dy++){
		for(dx = 0;dx < 8;dx++){
			if(bt(map,dy * 8 + dx)) color = text_color;
			else color = back_color;
			pos = (status[cpuid].posx + status[cpuid].x + dx) * byte_per_pixel + (status[cpuid].posy + status[cpuid].y + dy) * byte_per_scan_line;
			if(byte_per_pixel == 1)
				lfb[pos] = color;
			else if(byte_per_pixel == 2)
				*(u16*)(lfb + pos) = color;
			else if(byte_per_pixel == 4)
				*(u32*)(lfb + pos) = color;
			else{
				lfb[pos] = color;
				lfb[pos + 1] = color >> 8;
				lfb[pos + 2] = color >> 16;
			}
		}
	}
	status[cpuid].x += 8;
	SE();
}
void gui_init(){
	struct VESA_MODE * cur_mode_info;
	struct VESA_INFO * info;
	int a,b;
	int i,pix;
	int posx,posy;
	int cpuid;
	
	cur_mode_info = ADDRP2V(init_msg.CurModeInfo);
	info = ADDRP2V(init_msg.VESAInfo);
	high = cur_mode_info->yres;
	width = cur_mode_info->xres;
	byte_per_pixel = cur_mode_info->bits_per_pixel/8;
	byte_per_scan_line = cur_mode_info->byte_per_scan_line;
	lfb = mmio_map(cur_mode_info->lfb,info->mem_size * 65536);
	memset(lfb,0xff,high * byte_per_scan_line);
	max_cpuid = init_msg.CPUCount - 1;
	if(init_msg.CPUCount <= 1*1) a = 1;
	else if(init_msg.CPUCount <= 2*2) a = 2;
	else if(init_msg.CPUCount <= 3*3) a = 3;
	else if(init_msg.CPUCount <= 4*4) a = 4;
	else if(init_msg.CPUCount <= 5*5) a = 5;
	else if(init_msg.CPUCount <= 6*6) a = 6;
	else if(init_msg.CPUCount <= 7*7) a = 7;
	else if(init_msg.CPUCount <= 8*8) a = 8;
	else if(init_msg.CPUCount <= 9*9) a = 9;
	else if(init_msg.CPUCount <= 10*10) a = 10;
	
	if(a * (a - 1) >= init_msg.CPUCount) b = a - 1;
	else b = a;
	model_width = width / a;
	model_width -= border_width * 2;
	model_high = high / b;
	model_high -= border_width * 2;
	model_width &= ~0x07;
	model_high &= ~0x0f;
	model_per_line = a;
	status = kmalloc(sizeof(struct _MODEL_STATUS_) * init_msg.CPUCount,0);
	
	for(cpuid = 0;cpuid < init_msg.CPUCount;cpuid++){
		posx = (cpuid % a) * (2 * border_width + model_width);
		posy = (cpuid / a) * (2 * border_width + model_high);
		status[cpuid].posx = posx + border_width;
		status[cpuid].posy = posy + border_width;
		status[cpuid].x = status[cpuid].y = 0;
		for(pix = 0;pix < border_width;pix++){
			memset(lfb + posx * byte_per_pixel + posy * byte_per_scan_line,
				0x00,(model_width + border_width * 2) * byte_per_pixel);
		}
		for(i = 0;i < model_high;i++){
			memset(lfb + posx * byte_per_pixel + (posy + i + border_width) * byte_per_scan_line,
				0x00,border_width * byte_per_pixel);
			memset(lfb + (posx + model_width + border_width) * byte_per_pixel + (posy + i + border_width) * byte_per_scan_line,
				0x00,border_width * byte_per_pixel);
		}
		for(pix = 0;pix < border_width;pix++){
			memset(lfb + posx * byte_per_pixel + (posy + model_high + border_width) * byte_per_scan_line,
				0x00,(model_width + border_width * 2) * byte_per_pixel);
		}
		
	}
	init = 1;
	printk("%dX%d.\n",model_width,model_high);
}

